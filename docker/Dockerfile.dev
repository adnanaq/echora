# Dockerfile.dev â€” Development environment
FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies for development
RUN apt-get update && apt-get install -y \
  gcc \
  g++ \
  curl \
  git \
  && rm -rf /var/lib/apt/lists/*

# Install uv (modern fast package manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Copy dependency files first for caching
COPY pyproject.toml uv.lock ./

# Install dependencies including dev dependencies
RUN uv sync --frozen

# Copy source code
COPY apps/ ./apps/
COPY libs/ ./libs/
COPY README.md .

# Set environment variables
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV APP_ENV=development

# Expose port for dev server
EXPOSE 8002

# Optional: mount local source code for live reload in docker run
# docker run -v $(pwd)/src:/app/src ...

# Health check (optional for dev)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8002/health || exit 1

# Run application using uv to activate virtual environment
# Add apps/service/src to Python path so we can import service module
ENV PYTHONPATH=/app/apps/service/src:/app
CMD ["uv", "run", "python", "-m", "service.main"]

