---
title: Command API
date: 2026-02-19
tags:
  - services
  - command-api
  - n8n
  - orchestration
  - idempotency
status: active
related:
  - "[[n8n_orchestration]]"
  - "[[event_adapter]]"
  - "[[Architecture Index]]"
---

# Command API

## Overview

The Command API is a **FastAPI (Python) service** that acts as the single, authorised entry point for n8n (and any other external orchestration tool) to trigger actions on internal platform services. It enforces authentication, idempotency, and rate limiting in one place — internal services never handle these concerns directly from n8n.

> [!important] Boundary Rule
> n8n (and any external orchestration) calls the Command API only. It never calls internal gRPC services, PostgreSQL, NATS, or Qdrant directly. The Command API translates HTTP/JSON commands into internal gRPC calls and NATS publishes.

---

## Responsibilities

- **Authentication** — validate OAuth2 client-credentials + JWT on every request
- **Idempotency** — enforce `Idempotency-Key` header; store key + request hash + result in Redis
- **Rate limiting** — per-client and per-endpoint
- **Translation** — HTTP/JSON → internal gRPC or NATS
- **Error normalisation** — return deterministic error codes n8n can branch on

---

## Authentication

All mutating endpoints require:
- `Authorization: Bearer <jwt>` — issued by OAuth2 client-credentials flow
- `Idempotency-Key: <key>` — deterministic key generated by caller (see format below)

Scopes:
| Scope | Allowed endpoints |
|-------|------------------|
| `workflow.read` | read-only query endpoints |
| `workflow.execute` | all ingestion + update trigger endpoints |
| `workflow.approve` | stage-6 decision submission, replay endpoints |

---

## Idempotency

Redis-backed idempotency (TTL: 30 days).

| Key format | Example |
|-----------|---------|
| `tag-check:<source>:<tag_name>` | `tag-check:manami:2026-02-19` |
| `run-incremental:<snapshot_sha256>` | `run-incremental:abc123...` |
| `process-entry:<run_id>:<entry_key>` | `process-entry:42:sha256hex` |
| `stage6-review:<run_id>:<entry_key>:<decision_id>` | `stage6-review:42:sha256hex:uuid` |
| `replay-stage:<run_id>:<entry_key>:<stage_name>:<decision_id>` | `replay-stage:42:sha256hex:stage3:uuid` |

**Duplicate behavior**:
- Same key + same request hash → return prior result immediately (no re-execution)
- Same key + different request hash → `409 idempotency_conflict`

---

## Endpoints

All mutating endpoints require `Authorization` and `Idempotency-Key` headers.

### 1. `POST /workflow/check-tag`
Check latest upstream source tag against last processed snapshot.

**Input**: `{ "source": "manami" }`
**Output**: `{ "latest_tag": "2026-02-19", "changed": true, "latest_snapshot_id": 42 }`

---

### 2. `POST /workflow/start-incremental-run`
Initialise snapshot and run metadata for a changed tag.

**Input**: `{ "source": "manami", "tag": "2026-02-19", "artifact_url": "https://..." }`
**Output**: `{ "run_id": 42, "snapshot_id": 7 }`

---

### 3. `POST /workflow/build-diff`
Compute candidate new entries and detect initial review issues.

**Input**: `{ "run_id": 42, "snapshot_id": 7, "previous_snapshot_id": 6 }`
**Output**: `{ "candidate_count": 420, "entries_ref": "s3://...", "issues_ref": "s3://..." }`

---

### 4. `POST /workflow/process-stages`
Run enrichment stages (1–5, or from a specified stage for replay).

**Input**: `{ "run_id": 42, "entries_ref": "s3://...", "from_stage": 1 }`
**Output**: `{ "processed_count": 418, "failed_count": 2, "stage_summary": {...} }`

---

### 5. `POST /workflow/build-stage6-review`
Persist stage-6 review artifact for all entries and emit aggregate review alert.

**Input**: `{ "run_id": 42, "entries_ref": "s3://..." }`
**Output**: `{ "review_ref": "s3://...", "alert_ref": "slack://..." }`

---

### 6. `POST /workflow/submit-stage6-decisions`
Submit reviewed stage-6 decisions (entry-level and/or batch rules).

**Input**:
```json
{
  "run_id": 42,
  "entry_decisions": [
    { "entry_key": "sha256hex", "decision": "approve_ingest", "reviewed_by": "operator@team" }
  ],
  "batch_rules": [
    { "selector": {"issues_count": 0}, "decision": "approve_ingest", "reviewed_by": "operator@team" }
  ]
}
```
**Output**: `{ "accepted_count": 400, "rejected_count": 5, "pending_count": 15, "decision_batch_id": "uuid" }`

---

### 7. `POST /workflow/preview-stage6-batch`
Dry-run batch selector rules before final submission.

**Input**: `{ "run_id": 42, "batch_rules": [...] }`
**Output**: `{ "rule_matches": [...], "conflicts": [...], "would_remain_pending": 3 }`

---

### 8. `POST /workflow/replay-stage`
Replay one specified stage for selected entries and resume forward flow.

**Input**: `{ "run_id": 42, "decision_batch_id": "uuid", "target_stage": "stage3_character_match" }`
**Output**: `{ "replayed_count": 5, "skipped_count": 0, "failed_count": 0 }`

---

### 9. `POST /workflow/ingest-approved`
Ingest entries approved at the stage-6 gate.

**Input**: `{ "run_id": 42, "decision_batch_id": "uuid" }`
**Output**: `{ "ingested_count": 395, "rejected_count": 5, "partial_count": 10 }`

---

### 10. `POST /workflow/finalize-run`
Finalise run status from per-entry outcomes.

**Input**: `{ "run_id": 42 }`
**Output**: `{ "final_status": "success" }` — one of `success | partial_success | failed`

---

## Error Codes

All endpoints return structured errors n8n can branch on deterministically:

| Code | Meaning |
|------|---------|
| `validation_error` | Request payload failed schema validation |
| `idempotency_conflict` | Same key, different request body |
| `not_found` | Referenced run, snapshot, or entry does not exist |
| `run_lock_conflict` | Another run is already in progress for this source |
| `retryable_upstream_error` | Transient failure in a downstream service — n8n should retry |
| `non_retryable_error` | Permanent failure — n8n should route to DLQ |

---

## Tech Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| Framework | FastAPI (Python) | Consistent with enrichment/update services; async-native; OpenAPI docs free |
| Idempotency backend | Redis | Sub-millisecond key lookup; TTL management built-in |
| Auth | OAuth2 client-credentials + JWT | Industry standard; aligns with n8n Cloud auth support |
| Internal calls | gRPC (to PostgreSQL Service, Enrichment Service) | Typed, fast, schema-enforced |
| Artifact storage | S3 / MinIO | Avoids n8n Cloud filesystem limitation |

---

## Related Documentation

- [[n8n_orchestration|n8n Orchestration]] — workflows that call this API
- [[event_adapter|Event Adapter]] — NATS → n8n bridge (inbound direction)
- [[Architecture Index|Architecture Index]] — service overview

---

**Status**: Planned | **Last Updated**: 2026-02-19
