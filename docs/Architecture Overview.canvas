{
	"nodes":[
		{"id":"group-orchestration","type":"group","x":2080,"y":-460,"width":780,"height":825,"color":"5","label":"Orchestration Layer"},
		{"id":"group-services","type":"group","x":-440,"y":320,"width":1100,"height":240,"color":"4","label":"Internal Services"},
		{"id":"group-data","type":"group","x":-160,"y":740,"width":600,"height":200,"color":"2","label":"Data Layer"},
		{"id":"postgres001","type":"text","text":"# PostgreSQL Service\n\n**Tech**: Rust\n- sqlx\n- tonic (gRPC)\n- async-graphql\n**APIs**:\n- gRPC (agent)\n- GraphQL (backend)","x":50,"y":330,"width":250,"height":180,"color":"1"},
		{"id":"qdrant001","type":"text","text":"# Qdrant Service\n\n**Tech**: Python\n- qdrant-client\n- transformers\n**Role**: Vector search","x":380,"y":400,"width":250,"height":140,"color":"4"},
		{"id":"pgdb001","type":"text","text":"# PostgreSQL DB\n\n**Schema**: Anime, Character, Episode\n**Owner**: PostgreSQL Service","x":-140,"y":740,"width":240,"height":160,"color":"2"},
		{"id":"qdrantdb001","type":"text","text":"# Qdrant Vector DB\n\n**Vectors**: text (1024), image (768)\n**Collection**: anime_database","x":160,"y":740,"width":250,"height":160,"color":"2"},
		{"id":"note-flow","type":"text","text":"# Data Flow\n\n## NL Query (LLM enabled)\nBackend → Agent → (Qdrant + Postgres) → Backend\n\n## Direct Search (LLM disabled/down)\nBackend → Qdrant (direct) + Postgres → Backend\n\n## Initial Ingestion\nn8n → Command API → Ingestion Pipeline (stages 1–5)\n→ Stage-6 gate → ingest-approved\n→ NATS (anime.enriched) → PostgreSQL → outbox → NATS → Qdrant\n\n## Ongoing Updates (Temporal + SAGA)\nUpdate Service → NATS (episode.aired / anime.updated / character.updated)\n→ PostgreSQL (write + qdrant_outbox)\n→ NATS (anime.synced / character.synced) → Qdrant\n\n## DLQ / Risky Updates\nNATS → Event Adapter → n8n webhook → operator decision\n→ Command API → replay or approve","x":-360,"y":980,"width":570,"height":340,"color":"6"},
		{"id":"doc-db-schema","type":"file","file":"Database Schema.md","x":-620,"y":745,"width":300,"height":150},
		{"id":"backend001","type":"text","text":"# Backend (BFF)\n\n**Domain**: echora.tech (internal)\n**Tech**: Rust\n- axum\n- async-graphql\n**Role**: External API, routing","x":10,"y":3,"width":300,"height":150,"color":"1"},
		{"id":"frontend001","type":"text","text":"# Frontend\n\n**Domain**: animora.com (TBD)\n**Tech**: React/Next.js (TBD)","x":10,"y":-240,"width":300,"height":120,"color":"5"},
		{"id":"agent001","type":"text","text":"# Agent Service\n\n**Tech**: Python\n- instructor\n- openai\n**Role**: LLM orchestration","x":-390,"y":370,"width":250,"height":140,"color":"4"},
		{"id":"temporal001","type":"text","text":"# Temporal Server\n\n**Backend**: PostgreSQL (temporal DB)\n**Powers**: Update Service workers\n**Guarantees**:\n- Crash recovery\n- Per-item dynamic schedules\n**Ports**: 7233 (gRPC), 8080 (UI)\n**See**: [[temporal_infrastructure]]","x":1400,"y":1050,"width":300,"height":200,"color":"2"},
		{"id":"ingestion001","type":"text","text":"# Ingestion Pipeline\n\n**Tech**: Python\n- Pydantic\n- nats-py\n- libs/enrichment\n**Stages**: 1–5 enrichment\n+ Stage-6 gate (n8n)\n**Role**: New entries only\n**Output**: anime.enriched → NATS\n**See**: [[ingestion_pipeline]]","x":1570,"y":785,"width":260,"height":195,"color":"6"},
		{"id":"note-sync","type":"text","text":"# Model Synchronization\n\n**Problem Solved**: Zero schema duplication!\n\n- Ingestion: No DB models, publishes events\n- PostgreSQL Service: Only service with SQL models\n- Event-driven: NATS decouples services\n\n**See**: [[event_driven_architecture#Event Flow]]","x":255,"y":1030,"width":500,"height":200,"color":"3"},
		{"id":"doc-n8n","type":"file","file":"n8n_orchestration.md","x":1740,"y":-510,"width":280,"height":100},
		{"id":"commandapi001","type":"text","text":"# Command API\n\n**Tech**: FastAPI (Python)\n- OAuth2 + JWT\n- Redis idempotency\n**10 endpoints**:\ncheck-tag, start-run, build-diff,\nprocess-stages, stage6-review,\nsubmit-decisions, preview-batch,\nreplay-stage, ingest-approved,\nfinalize-run\n**See**: [[command_api]]","x":2120,"y":130,"width":300,"height":220,"color":"5"},
		{"id":"eventadapter001","type":"text","text":"# Event Adapter\n\n**Tech**: Python\n+ NATS pull consumer\n**Role**: NATS → n8n bridge\n**Subscribes**:\n- anime.dlq.*\n- anime.updated (risk-flagged)\n- ingestion.review.ready\n**Forwards**: Redacted JSON\n(HMAC-signed webhook)\n**See**: [[event_adapter]]","x":2460,"y":140,"width":300,"height":210,"color":"4"},
		{"id":"n8n001","type":"text","text":"# n8n Orchestration\n\n**Hosting**: Local (dev) / n8n Cloud (prod)\n**Role**: Async control plane\n**Owns**:\n- Incremental ingestion flow\n- Stage-6 review gate\n- DLQ triage + replay\n- Risky update approval\n**Connects**: Cloudflare Tunnel\n→ Command API\n**See**: [[n8n_orchestration]]","x":2310,"y":-410,"width":300,"height":210,"color":"6"},
		{"id":"updateworker001","type":"text","text":"# Update Service\n\n**Tech**: Python\n- Temporal SDK\n- nats-py\n- libs/enrichment\n**Workflows**:\n- EpisodeAirTracking\n- ScoreSync\n- CharacterRefresh\n- AnimeMetadataRefresh\n**Output**: Events → NATS\n**See**: [[update_service]]","x":990,"y":790,"width":260,"height":220,"color":"4"},
		{"id":"nats001","type":"text","text":"# NATS JetStream\n\n**From Update Service / Pipeline:**\n- anime.enriched\n- anime.updated\n- anime.episode.aired\n- character.updated\n\n**From PostgreSQL Service (outbox):**\n- anime.created\n- anime.synced\n- anime.deleted\n- character.synced\n\n**To Event Adapter:**\n- anime.dlq.*\n- anime.updated (risk-flagged)\n- ingestion.review.ready\n\n**See**: [[event_driven_architecture]]","x":1100,"y":-790,"width":260,"height":330,"color":"3"},
		{"id":"doc-events","type":"file","file":"event_driven_architecture.md","x":630,"y":-820,"width":300,"height":150},
		{"id":"doc-schema","type":"file","file":"event_schema_specification.md","x":1500,"y":-895,"width":300,"height":150},
		{"id":"doc-postgres","type":"file","file":"postgres_integration_architecture_decision.md","x":630,"y":140,"width":300,"height":105}
	],
	"edges":[
		{"id":"edge001","fromNode":"frontend001","fromSide":"bottom","toNode":"backend001","toSide":"top","label":"GraphQL"},
		{"id":"edge002","fromNode":"backend001","fromSide":"bottom","toNode":"agent001","toSide":"top","color":"4","label":"gRPC (NL queries)"},
		{"id":"edge003","fromNode":"backend001","fromSide":"bottom","toNode":"postgres001","toSide":"top","color":"1","label":"GraphQL (hydration)"},
		{"id":"edge004","fromNode":"agent001","fromSide":"right","toNode":"postgres001","toSide":"left","color":"4","label":"gRPC (graph)"},
		{"id":"edge005","fromNode":"agent001","fromSide":"bottom","toNode":"qdrant001","toSide":"left","color":"4","label":"gRPC (vectors)"},
		{"id":"edge006","fromNode":"postgres001","fromSide":"bottom","toNode":"pgdb001","toSide":"top","label":"SQL writes"},
		{"id":"edge007","fromNode":"qdrant001","fromSide":"bottom","toNode":"qdrantdb001","toSide":"top","label":"vector ops"},
		{"id":"edge008","fromNode":"ingestion001","fromSide":"top","toNode":"nats001","toSide":"bottom","color":"6","label":"publish\nAnimeEnrichedEvent"},
		{"id":"edge009","fromNode":"nats001","fromSide":"left","toNode":"postgres001","toSide":"right","color":"3","label":"consume\nenriched events"},
		{"id":"edge010","fromNode":"postgres001","fromSide":"right","toNode":"nats001","toSide":"left","color":"3","label":"publish via outbox\nanime.created\nanime.synced"},
		{"id":"edge011","fromNode":"nats001","fromSide":"bottom","toNode":"qdrant001","toSide":"right","color":"3","label":"consume\nanime.created\nanime.synced"},
		{"id":"edge012","fromNode":"nats001","fromSide":"top","toNode":"doc-events","toSide":"right","color":"5","label":"docs"},
		{"id":"edge013","fromNode":"nats001","fromSide":"right","toNode":"doc-schema","toSide":"left","color":"5","label":"event schemas"},
		{"id":"edge014","fromNode":"postgres001","fromSide":"right","toNode":"doc-postgres","toSide":"left","color":"5","label":"architecture"},
		{"id":"edge016","fromNode":"backend001","fromSide":"right","toNode":"qdrant001","toSide":"top","color":"2","label":"gRPC direct\n(LLM disabled/down)"},
		{"id":"edge017","fromNode":"updateworker001","fromSide":"top","toNode":"nats001","toSide":"bottom","color":"4","label":"publish\nEpisodeAiredEvent\nAnimeUpdatedEvent\nCharacterUpdatedEvent"},
		{"id":"edge018","fromNode":"updateworker001","fromSide":"left","toNode":"postgres001","toSide":"bottom","color":"4","label":"query schedule\n(GraphQL)"},
		{"id":"3a7aaa0622257f5a","fromNode":"pgdb001","fromSide":"left","toNode":"doc-db-schema","toSide":"right","color":"4","label":"schema"},
		{"id":"edge-n8n-commandapi","fromNode":"n8n001","fromSide":"bottom","toNode":"commandapi001","toSide":"top","color":"6","label":"HTTPS\n(Cloudflare Tunnel)"},
		{"id":"edge-commandapi-postgres","fromNode":"commandapi001","fromSide":"left","toNode":"postgres001","toSide":"right","color":"5","label":"gRPC\n(state mutations)"},
		{"id":"edge-commandapi-ingestion","fromNode":"commandapi001","fromSide":"left","toNode":"ingestion001","toSide":"right","color":"5","label":"trigger\n(pipeline stages)"},
		{"id":"edge-commandapi-updateservice","fromNode":"commandapi001","fromSide":"left","toNode":"updateworker001","toSide":"right","color":"5","label":"trigger\n(score sync /\nmetadata refresh)"},
		{"id":"edge-nats-eventadapter","fromNode":"nats001","fromSide":"right","toNode":"eventadapter001","toSide":"left","color":"3","label":"DLQ / risk-flagged\nevents"},
		{"id":"edge-eventadapter-n8n","fromNode":"eventadapter001","fromSide":"top","toNode":"n8n001","toSide":"right","color":"4","label":"webhook\n(redacted JSON)"},
		{"id":"edge-temporal-updateservice","fromNode":"temporal001","fromSide":"left","toNode":"updateworker001","toSide":"right","color":"2","label":"powers\n(durable execution)"},
		{"id":"edge-n8n-docn8n","fromNode":"n8n001","fromSide":"left","toNode":"doc-n8n","toSide":"right","color":"5","label":"docs"}
	]
}