name: Proto Stubs Check

on:
  pull_request:
    paths:
      - "protos/**/*.proto"
      - "scripts/generate-proto.py"
      - "scripts/check_anime_model_proto_contract.py"
      - "libs/common/src/common/models/anime.py"
      - "libs/common/src/shared_proto/**"
      - "apps/vector_service/src/vector_proto/**"
      - "apps/enrichment_service/src/enrichment_proto/**"
      - "scripts/BUILD"
      - "pants.toml"
      - "pyproject.toml"
      - "uv.lock"
      - "buf.yaml"
  push:
    branches: ["main"]
    paths:
      - "protos/**/*.proto"
      - "scripts/generate-proto.py"
      - "scripts/check_anime_model_proto_contract.py"
      - "libs/common/src/common/models/anime.py"
      - "libs/common/src/shared_proto/**"
      - "apps/vector_service/src/vector_proto/**"
      - "apps/enrichment_service/src/enrichment_proto/**"
      - "scripts/BUILD"
      - "pants.toml"
      - "pyproject.toml"
      - "uv.lock"
      - "buf.yaml"

jobs:
  proto-stubs-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install buf
        run: |
          BUF_VERSION="1.50.0"
          curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" \
            -o /usr/local/bin/buf
          chmod +x /usr/local/bin/buf

      # Check 1: Proto style — enforces STANDARD naming/style rules (field names,
      # message names, enum conventions) defined in buf.yaml.
      - name: Lint proto files
        run: buf lint

      # Check 2: Proto backward-compatibility — fails if any breaking change is
      # introduced: field removed, type changed, field number reused, message renamed.
      # Runs on PRs only; compares branch against main. Requires fetch-depth: 0.
      - name: Check for breaking proto changes
        if: github.event_name == 'pull_request'
        run: buf breaking protos/ --against ".git#branch=main"

      - name: Restore Pants cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pants
          key: ${{ runner.os }}-pants-${{ hashFiles('pants.toml', 'pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-pants-

      # Check 3: Co-change policy — anime.py (Pydantic source of truth) and
      # anime.proto (manually maintained mirror) must always move together.
      # Fails if anime.py is changed in this PR without a matching proto update.
      - name: Enforce anime model/proto co-change
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail

          MODEL_PATH="libs/common/src/common/models/anime.py"
          PROTO_PATH="protos/shared_proto/v1/anime.proto"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}")"

          if echo "${CHANGED_FILES}" | grep -Fxq "${MODEL_PATH}"; then
            if ! echo "${CHANGED_FILES}" | grep -Fxq "${PROTO_PATH}"; then
              echo "Detected '${MODEL_PATH}' change without '${PROTO_PATH}' update."
              echo "Please update proto contract alongside anime model changes."
              exit 1
            fi
          fi

      # Check 4: Generation health — runs grpcio-tools against all proto targets.
      # Fails if any proto file is missing or has a syntax error that prevents
      # stub generation. Also produces fresh stubs for checks 5 and 6.
      - name: Regenerate protobuf stubs
        run: ./pants run scripts/generate-proto.py

      # Check 5: Semantic parity — compares Pydantic model field names against
      # proto message field names at runtime. Catches drift that buf cannot see:
      # a field present in anime.py but absent from the proto (or vice versa).
      - name: Validate anime model/proto contract
        run: ./pants run scripts/check_anime_model_proto_contract.py

      # Check 6: Stub freshness — fails if the checked-in stubs differ from what
      # generate-proto.py just produced. Catches the case where proto was changed
      # but the regenerated stubs were never committed.
      - name: Fail on generated stub drift
        run: |
          git diff --exit-code -- \
            libs/common/src/shared_proto \
            apps/vector_service/src/vector_proto \
            apps/enrichment_service/src/enrichment_proto

