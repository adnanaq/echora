name: Proto Stubs Check

on:
  pull_request:
    paths:
      - "protos/**/*.proto"
      - "scripts/generate-proto.py"
      - "scripts/check_anime_model_proto_contract.py"
      - "libs/common/src/common/models/anime.py"
      - "libs/common/src/shared_proto/**"
      - "apps/vector_service/src/vector_proto/**"
      - "apps/enrichment_service/src/enrichment_proto/**"
      - "scripts/BUILD"
      - "pants.toml"
      - "pyproject.toml"
      - "uv.lock"
      - "buf.yaml"
  push:
    branches: ["main"]
    paths:
      - "protos/**/*.proto"
      - "scripts/generate-proto.py"
      - "scripts/check_anime_model_proto_contract.py"
      - "libs/common/src/common/models/anime.py"
      - "libs/common/src/shared_proto/**"
      - "apps/vector_service/src/vector_proto/**"
      - "apps/enrichment_service/src/enrichment_proto/**"
      - "scripts/BUILD"
      - "pants.toml"
      - "pyproject.toml"
      - "uv.lock"
      - "buf.yaml"

jobs:
  proto-stubs-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install buf
        run: |
          BUF_VERSION="1.50.0"
          curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" \
            -o /usr/local/bin/buf
          chmod +x /usr/local/bin/buf

      - name: Lint proto files
        run: buf lint

      - name: Install proto tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install grpcio-tools==1.78.0

      - name: Restore Pants cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pants
          key: ${{ runner.os }}-pants-${{ hashFiles('pants.toml', 'pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-pants-

      - name: Enforce anime model/proto co-change
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail

          MODEL_PATH="libs/common/src/common/models/anime.py"
          PROTO_PATH="protos/shared_proto/v1/anime.proto"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}")"

          if echo "${CHANGED_FILES}" | grep -Fxq "${MODEL_PATH}"; then
            if ! echo "${CHANGED_FILES}" | grep -Fxq "${PROTO_PATH}"; then
              echo "Detected '${MODEL_PATH}' change without '${PROTO_PATH}' update."
              echo "Please update proto contract alongside anime model changes."
              exit 1
            fi
          fi

      - name: Regenerate protobuf stubs
        run: ./pants run scripts/generate-proto.py

      - name: Validate anime model/proto contract
        run: ./pants run scripts/check_anime_model_proto_contract.py

      - name: Fail on generated stub drift
        run: |
          git diff --exit-code -- \
            libs/common/src/shared_proto \
            apps/vector_service/src/vector_proto \
            apps/enrichment_service/src/enrichment_proto

      - name: Package proto artifacts
        run: |
          set -euo pipefail

          ARTIFACTS_ROOT="dist/proto-artifacts"
          PYTHON_ARTIFACT_ROOT="${ARTIFACTS_ROOT}/python"
          RUST_ARTIFACT_ROOT="${ARTIFACTS_ROOT}/rust"
          mkdir -p "${PYTHON_ARTIFACT_ROOT}" "${RUST_ARTIFACT_ROOT}/generated"

          cp -R libs/common/src/shared_proto "${PYTHON_ARTIFACT_ROOT}/"
          cp -R apps/vector_service/src/vector_proto "${PYTHON_ARTIFACT_ROOT}/"
          cp -R apps/enrichment_service/src/enrichment_proto "${PYTHON_ARTIFACT_ROOT}/"
          cp -R protos "${PYTHON_ARTIFACT_ROOT}/"

          cp -R protos "${RUST_ARTIFACT_ROOT}/"
          python -m grpc_tools.protoc \
            -I protos \
            --include_imports \
            --descriptor_set_out="${RUST_ARTIFACT_ROOT}/generated/echora_descriptor_set.pb" \
            $(find protos -type f -name '*.proto' | sort)

          cat > "${PYTHON_ARTIFACT_ROOT}/metadata.json" <<EOF
          {
            "generated_at_utc": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "artifact_kind": "python",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "generator_command": "./pants run scripts/generate-proto.py"
          }
          EOF

          cat > "${RUST_ARTIFACT_ROOT}/metadata.json" <<EOF
          {
            "generated_at_utc": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "artifact_kind": "rust",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "generator_command": "./pants run scripts/generate-proto.py",
            "descriptor_command": "python -m grpc_tools.protoc -I protos --include_imports --descriptor_set_out=generated/echora_descriptor_set.pb ..."
          }
          EOF

          (
            cd "${PYTHON_ARTIFACT_ROOT}"
            find . -type f ! -name checksums.txt -print0 \
              | sort -z \
              | xargs -0 sha256sum > checksums.txt
          )

          (
            cd "${RUST_ARTIFACT_ROOT}"
            find . -type f ! -name checksums.txt -print0 \
              | sort -z \
              | xargs -0 sha256sum > checksums.txt
          )

      - name: Upload python proto artifacts
        uses: actions/upload-artifact@v6
        with:
          name: proto-python-artifacts-${{ github.ref_name }}-${{ github.sha }}
          path: dist/proto-artifacts/python
          if-no-files-found: error
          retention-days: 14

      - name: Upload rust proto artifacts
        uses: actions/upload-artifact@v6
        with:
          name: proto-rust-artifacts-${{ github.ref_name }}-${{ github.sha }}
          path: dist/proto-artifacts/rust
          if-no-files-found: error
          retention-days: 14
